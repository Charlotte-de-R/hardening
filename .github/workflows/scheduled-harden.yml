      - name: Trivy scan
        id: trivy_scan
        if: steps.check.outputs.needs_update == 'true' || inputs.force_build == true
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.FULL_IMAGE_NAME }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          ignore-unfixed: true
          timeout: '15m'
          skip-dirs: '/var/lib/dpkg/info,/var/cache'
          scanners: 'vuln'
        continue-on-error: true

      - name: Check Trivy scan result
        id: check_trivy
        if: steps.check.outputs.needs_update == 'true' || inputs.force_build == true
        run: |
          if [ ! -f trivy-results.sarif ] || [ ! -s trivy-results.sarif ]; then
            echo "trivy_failed=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Primary Trivy scan failed or produced no output"
          else
            echo "trivy_failed=false" >> $GITHUB_OUTPUT
            echo "âœ… Primary Trivy scan succeeded"
          fi

      - name: Trivy fallback scan
        if: steps.check_trivy.outputs.trivy_failed == 'true' && (steps.check.outputs.needs_update == 'true' || inputs.force_build == true)
        run: |
          echo "ðŸ”„ Attempting fallback Trivy scan..."
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v ${{ github.workspace }}:/output \
            aquasec/trivy:0.56.1 \
            image \
            --format sarif \
            --output /output/trivy-results-fallback.sarif \
            --severity CRITICAL,HIGH \
            --ignore-unfixed \
            --scanners vuln \
            --skip-dirs '/var/lib/dpkg/info,/var/cache,/var/lib/mysql' \
            --timeout 10m \
            ${{ env.FULL_IMAGE_NAME }} 2>&1 | tee trivy-fallback.log || true
          
          if [ -f trivy-results-fallback.sarif ] && [ -s trivy-results-fallback.sarif ]; then
            mv trivy-results-fallback.sarif trivy-results.sarif
            echo "âœ… Fallback scan completed successfully"
          else
            echo "âš ï¸ Fallback scan also failed, creating minimal SARIF for upload"
            cat > trivy-results.sarif << 'EOF'
          {
            "version": "2.1.0",
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "runs": [{
              "tool": {
                "driver": {
                  "name": "Trivy",
                  "informationUri": "https://github.com/aquasecurity/trivy",
                  "fullName": "Trivy Vulnerability Scanner",
                  "version": "fallback-unavailable"
                }
              },
              "results": []
            }]
          }
          EOF
            echo "â„¹ï¸ Created empty SARIF to prevent workflow failure"
          fi
        continue-on-error: true
