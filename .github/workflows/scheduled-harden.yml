name: Scheduled Build & Scan (Matrix Strategy)

on:
  schedule:
    - cron: '30 19 * * *'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build even if no updates found'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_OWNER: charlotte-de-r
  IMAGE_REPO: hardening

jobs:
  build-and-harden:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write
      id-token: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: tailscale
            context: ./dockerfiles/tailscale
            image_tag: tailscale:hardened
          - name: crowdsec
            context: ./dockerfiles/crowdsec
            image_tag: crowdsec:hardened
          - name: socket-proxy
            context: ./dockerfiles/socket-proxy
            image_tag: socket-proxy:hardened
          - name: promtail
            context: ./dockerfiles/promtail
            image_tag: promtail:hardened
          - name: immich-server
            context: ./dockerfiles/immich-server
            image_tag: immich-server:hardened
          - name: immich-machine-learning
            context: ./dockerfiles/immich-machine-learning
            image_tag: immich-machine-learning:hardened
          - name: immich-redis
            context: ./dockerfiles/immich-redis
            image_tag: immich-redis:hardened
          - name: immich-postgres
            context: ./dockerfiles/immich-postgres
            image_tag: immich-postgres:hardened
          - name: nextcloud
            context: ./dockerfiles/nextcloud
            image_tag: nextcloud:hardened
          - name: mariadb
            context: ./dockerfiles/mariadb
            image_tag: mariadb:hardened
          - name: vaultwarden
            context: ./dockerfiles/vaultwarden
            image_tag: vaultwarden:hardened

    steps:
      - name: Determine Cache Strategy
        id: cache_strat
        run: |
          if [ "${{ inputs.force_build }}" == "true" ]; then
            echo "CACHE_KEY=${{ github.run_id }}" >> $GITHUB_ENV
          else
            echo "CACHE_KEY=$(date +%Y.%U)" >> $GITHUB_ENV
          fi

      - name: Set image full path
        run: echo "FULL_IMAGE_NAME=${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_REPO }}/${{ matrix.image_tag }}" >> $GITHUB_ENV

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make scripts executable
        run: chmod +x update_dockerfiles.sh check_update.sh

      - name: Inject Security Hardening Templates
        run: ./update_dockerfiles.sh

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.6.0

      - name: Check Updates
        id: check
        run: ./check_update.sh ${{ env.FULL_IMAGE_NAME }}

      - name: Build and Push
        if: steps.check.outputs.needs_update == 'true' || inputs.force_build == true
        uses: docker/build-push-action@v5
        with:
          no-cache: true
          context: ${{ matrix.context }}
          file: ${{ matrix.context }}/Dockerfile.hardened
          push: true
          tags: ${{ env.FULL_IMAGE_NAME }}
          build-args: |
            CACHEBUST=${{ env.CACHE_KEY }}
          secrets: |
            GIT_AUTH_TOKEN=${{ secrets.GITHUB_TOKEN }}
          provenance: false
          sbom: false

      - name: Trivy scan
        id: trivy_scan
        if: steps.check.outputs.needs_update == 'true' || inputs.force_build == true
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.FULL_IMAGE_NAME }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          ignore-unfixed: true
          timeout: '15m'
          skip-dirs: '/var/lib/dpkg/info,/var/cache'
          scanners: 'vuln'
        continue-on-error: true

      - name: Check Trivy scan result
        id: check_trivy
        if: steps.check.outputs.needs_update == 'true' || inputs.force_build == true
        run: |
          if [ ! -f trivy-results.sarif ] || [ ! -s trivy-results.sarif ]; then
            echo "trivy_failed=true" >> $GITHUB_OUTPUT
          else
            echo "trivy_failed=false" >> $GITHUB_OUTPUT
          fi
      - name: Trivy fallback - Method 2 (Tarball)
        if: steps.check_trivy.outputs.trivy_failed == 'true' && (steps.check.outputs.needs_update == 'true' || inputs.force_build == true)
        run: |
          echo "ðŸ”„ Fallback: Export as tarball and scan"
          docker pull ${{ env.FULL_IMAGE_NAME }}
          docker save ${{ env.FULL_IMAGE_NAME }} -o ${{ github.workspace }}/image.tar
          
          docker run --rm \
            -v ${{ github.workspace }}:/work \
            -e TRIVY_TEMP_DIR=/work/.trivy-temp \
            aquasec/trivy:0.56.1 \
            image \
            --input /work/image.tar \
            --format sarif \
            --output /work/trivy-results.sarif \
            --severity CRITICAL,HIGH \
            --ignore-unfixed \
            --scanners vuln \
            --timeout 10m || echo "âš ï¸ Fallback scan failed"
          
          rm -f image.tar
          rm -rf .trivy-temp
          
          if [ ! -f trivy-results.sarif ] || [ ! -s trivy-results.sarif ]; then
            echo "âš ï¸ Creating minimal SARIF"
            cat > trivy-results.sarif <<'EOFMARKER'
          {"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[{"tool":{"driver":{"name":"Trivy","version":"unavailable"}},"results":[]}]}
          EOFMARKER
          fi
        continue-on-error: true
