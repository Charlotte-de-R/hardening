      - name: Trivy scan
        id: trivy_scan
        if: steps.check.outputs.needs_update == 'true' || inputs.force_build == true
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.FULL_IMAGE_NAME }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          ignore-unfixed: true
          timeout: '15m'
          skip-dirs: '/var/lib/dpkg/info,/var/cache'
          scanners: 'vuln'
        continue-on-error: true

      - name: Check Trivy scan result
        id: check_trivy
        if: steps.check.outputs.needs_update == 'true' || inputs.force_build == true
        run: |
          if [ ! -f trivy-results.sarif ] || [ ! -s trivy-results.sarif ]; then
            echo "trivy_failed=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Primary Trivy scan failed"
          else
            echo "trivy_failed=false" >> $GITHUB_OUTPUT
            echo "âœ… Primary Trivy scan succeeded"
          fi

      - name: Trivy fallback scan (Method 1 - Direct Docker)
        if: steps.check_trivy.outputs.trivy_failed == 'true' && (steps.check.outputs.needs_update == 'true' || inputs.force_build == true)
        run: |
          echo "ðŸ”„ Fallback Method 1: Direct Docker scan..."
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v ${{ github.workspace }}:/output \
            aquasec/trivy:0.56.1 \
            image \
            --format sarif \
            --output /output/trivy-fb1.sarif \
            --severity CRITICAL,HIGH \
            --ignore-unfixed \
            --scanners vuln \
            --skip-dirs '/var/lib/dpkg/info,/var/cache,/var/lib/mysql' \
            --timeout 10m \
            ${{ env.FULL_IMAGE_NAME }} || echo "Method 1 failed"
          
          if [ -f trivy-fb1.sarif ] && [ -s trivy-fb1.sarif ]; then
            mv trivy-fb1.sarif trivy-results.sarif
            echo "âœ… Method 1 succeeded"
            echo "fallback1_success=true" >> $GITHUB_OUTPUT
          else
            echo "fallback1_success=false" >> $GITHUB_OUTPUT
          fi
        id: fallback1
        continue-on-error: true

      - name: Trivy fallback scan (Method 2 - Export and Scan)
        if: steps.fallback1.outputs.fallback1_success != 'true' && steps.check_trivy.outputs.trivy_failed == 'true' && (steps.check.outputs.needs_update == 'true' || inputs.force_build == true)
        run: |
          echo "ðŸ”„ Fallback Method 2: Export image as tarball and scan..."
          
          # ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’tarballã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
          docker pull ${{ env.FULL_IMAGE_NAME }}
          docker save ${{ env.FULL_IMAGE_NAME }} -o /tmp/image.tar
          
          # tarballã‚’ã‚¹ã‚­ãƒ£ãƒ³
          docker run --rm \
            -v /tmp:/tmp:ro \
            -v ${{ github.workspace }}:/output \
            aquasec/trivy:0.56.1 \
            image \
            --input /tmp/image.tar \
            --format sarif \
            --output /output/trivy-fb2.sarif \
            --severity CRITICAL,HIGH \
            --ignore-unfixed \
            --scanners vuln \
            --timeout 10m || echo "Method 2 failed"
          
          if [ -f trivy-fb2.sarif ] && [ -s trivy-fb2.sarif ]; then
            mv trivy-fb2.sarif trivy-results.sarif
            echo "âœ… Method 2 succeeded"
            echo "fallback2_success=true" >> $GITHUB_OUTPUT
          else
            echo "fallback2_success=false" >> $GITHUB_OUTPUT
          fi
          
          # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          rm -f /tmp/image.tar
        id: fallback2
        continue-on-error: true

      - name: Trivy fallback scan (Method 3 - Filesystem only)
        if: steps.fallback2.outputs.fallback2_success != 'true' && steps.fallback1.outputs.fallback1_success != 'true' && steps.check_trivy.outputs.trivy_failed == 'true' && (steps.check.outputs.needs_update == 'true' || inputs.force_build == true)
        run: |
          echo "ðŸ”„ Fallback Method 3: Filesystem-only scan (æœ€çµ‚æ‰‹æ®µ)..."
          
          # ã‚³ãƒ³ãƒ†ãƒŠã‚’ä¸€æ™‚çš„ã«èµ·å‹•ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’ãƒžã‚¦ãƒ³ãƒˆ
          CONTAINER_ID=$(docker create ${{ env.FULL_IMAGE_NAME }})
          docker export $CONTAINER_ID > /tmp/container-fs.tar
          docker rm $CONTAINER_ID
          
          mkdir -p /tmp/container-fs
          tar -xf /tmp/container-fs.tar -C /tmp/container-fs
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’ã‚¹ã‚­ãƒ£ãƒ³
          docker run --rm \
            -v /tmp/container-fs:/scan:ro \
            -v ${{ github.workspace }}:/output \
            aquasec/trivy:0.56.1 \
            filesystem \
            /scan \
            --format sarif \
            --output /output/trivy-fb3.sarif \
            --severity CRITICAL,HIGH \
            --ignore-unfixed \
            --scanners vuln \
            --timeout 10m || echo "Method 3 failed"
          
          if [ -f trivy-fb3.sarif ] && [ -s trivy-fb3.sarif ]; then
            mv trivy-fb3.sarif trivy-results.sarif
            echo "âœ… Method 3 succeeded"
            echo "fallback3_success=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ All scan methods failed"
            echo "fallback3_success=false" >> $GITHUB_OUTPUT
          fi
          
          # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          rm -rf /tmp/container-fs /tmp/container-fs.tar
        id: fallback3
        continue-on-error: true

      - name: Create minimal SARIF if all scans failed
        if: |
          (steps.check.outputs.needs_update == 'true' || inputs.force_build == true) && 
          steps.check_trivy.outputs.trivy_failed == 'true' &&
          steps.fallback1.outputs.fallback1_success != 'true' &&
          steps.fallback2.outputs.fallback2_success != 'true' &&
          steps.fallback3.outputs.fallback3_success != 'true'
        run: |
          echo "âš ï¸ Creating minimal SARIF (all scan methods failed)"
          cat > trivy-results.sarif <<'EOFMARKER'
          {
            "version": "2.1.0",
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "runs": [{
              "tool": {
                "driver": {
                  "name": "Trivy",
                  "informationUri": "https://github.com/aquasecurity/trivy",
                  "fullName": "Trivy Vulnerability Scanner",
                  "version": "scan-unavailable"
                }
              },
              "results": [],
              "invocations": [{
                "executionSuccessful": false,
                "toolExecutionNotifications": [{
                  "level": "warning",
                  "message": {
                    "text": "Image scan failed after multiple retry attempts. Manual review recommended."
                  }
                }]
              }]
            }]
          }
          EOFMARKER
        continue-on-error: true

      - name: Sign image
        if: steps.check.outputs.needs_update == 'true' || inputs.force_build == true
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: cosign sign --yes ${{ env.FULL_IMAGE_NAME }}

      - name: Upload Trivy results
        if: (steps.check.outputs.needs_update == 'true' || inputs.force_build == true) && hashFiles('trivy-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results.sarif'
          category: ${{ matrix.name }}
        continue-on-error: true
