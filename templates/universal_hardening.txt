# --- COMMON HARDENING START (DO NOT EDIT MANUALLY) ---
ARG CACHEBUST=1
RUN echo "Cache bust: $CACHEBUST" && \
    export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:$PATH" && \
    if command -v apk >/dev/null 2>&1; then \
        echo "â›°ï¸ Alpine Linux detected" && \
        (apk update || echo "âš ï¸ apk update failed") && \
        (apk upgrade --no-cache || echo "âš ï¸ apk upgrade failed") && \
        (apk add --no-cache --upgrade zlib sqlite-libs libcrypto3 libssl3 || echo "âš ï¸ Library upgrade failed") && \
        (apk del --no-cache nano vim git || true) && \
        rm -rf /var/cache/apk/* /usr/share/man/* || true; \
    elif command -v apt-get >/dev/null 2>&1; then \
        echo "ðŸŒ€ Debian/Ubuntu detected" && \
        export DEBIAN_FRONTEND=noninteractive && \
        (apt-get update -o Acquire::Retries=3 || echo "âš ï¸ apt-get update failed") && \
        (apt-get upgrade -y -o Acquire::Retries=3 || echo "âš ï¸ apt-get upgrade failed") && \
        echo "ðŸ”’ Installing critical security updates from Debian sid..." && \
        (echo "deb [trusted=yes] http://deb.debian.org/debian sid main" > /etc/apt/sources.list.d/sid.list && \
         apt-get update -o Acquire::Retries=3 || echo "âš ï¸ sid update failed") && \
        (apt-get install -y --no-install-recommends --allow-unauthenticated -t sid \
            zlib1g \
            libsqlite3-0 \
            openssl \
            ca-certificates 2>/dev/null || \
         echo "âš ï¸ sid packages failed, using default versions") && \
        (apt-get purge -y --auto-remove vim nano git telnet ftp man-db doc-debian 2>/dev/null || true) && \
        apt-get clean && \
        rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* /usr/share/doc/* /usr/share/man/* /etc/apt/sources.list.d/sid.list || true; \
    else \
        echo "âš ï¸ No supported package manager. Skipping." && true; \
    fi && \
    echo "ðŸ§¹ Optimizing Docker layers for Trivy scanning..." && \
    (find /var/lib/dpkg -type f -name "*-old" -delete 2>/dev/null || true) && \
    (find /var/lib/apt/lists -type f -delete 2>/dev/null || true) && \
    (rm -rf /usr/share/doc/* /usr/share/man/* /usr/share/info/* /var/cache/debconf/* 2>/dev/null || true)
# --- COMMON HARDENING END ---
